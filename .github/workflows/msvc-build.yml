name: MSVC Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  vs2026-build:
    name: MSVC 2026 Build (${{ matrix.build_type }})
    runs-on: windows-latest
    strategy:
      matrix:
        build_type: >-
          ${{
            github.event_name == 'pull_request' && fromJson('["Release"]') ||
            fromJson('["Release", "Debug"]')
          }}
    steps:
      - name: Check VS2026 (v144 toolset) availability
        id: check_vs2026
        run: |
          # Check if VS2026 toolset (v144) is available
          $vs2026Path = "C:\Program Files\Microsoft Visual Studio\2026"
          $v144Toolset = Get-ChildItem "C:\Program Files\Microsoft Visual Studio\*\*\MSBuild\Microsoft\VC\v144" -ErrorAction SilentlyContinue
          
          if (Test-Path $vs2026Path) {
            echo "VS2026_AVAILABLE=true" >> $env:GITHUB_OUTPUT
            echo "✅ Visual Studio 2026 is installed at: $vs2026Path"
          } elseif ($v144Toolset) {
            echo "VS2026_AVAILABLE=true" >> $env:GITHUB_OUTPUT
            echo "✅ v144 toolset found at: $($v144Toolset.FullName)"
          } else {
            echo "VS2026_AVAILABLE=false" >> $env:GITHUB_OUTPUT
            echo "⏭️ VS2026 (v144 toolset) is not available on this runner."
            echo "⏭️ Skipping VS2026 build. This is expected until GitHub adds VS2026 support to windows-latest runners."
            echo ""
            echo "=== Available Visual Studio Installations ==="
            Get-ChildItem "C:\Program Files\Microsoft Visual Studio" -ErrorAction SilentlyContinue | Select-Object Name
            echo ""
            echo "=== Available MSBuild Toolsets ==="
            Get-ChildItem "C:\Program Files\Microsoft Visual Studio\*\*\MSBuild\Microsoft\VC" -ErrorAction SilentlyContinue | Select-Object Name
          }
        shell: powershell

      - name: Checkout repository
        if: steps.check_vs2026.outputs.VS2026_AVAILABLE == 'true'
        uses: actions/checkout@v4
      
      - name: Setup Visual Studio environment
        if: steps.check_vs2026.outputs.VS2026_AVAILABLE == 'true'
        uses: microsoft/setup-msbuild@v1.1

      - name: Configure CMake
        if: steps.check_vs2026.outputs.VS2026_AVAILABLE == 'true'
        run: |
          mkdir build-vs2026
          cd build-vs2026
          cmake .. -T v144 # vs2026

      - name: Build
        if: steps.check_vs2026.outputs.VS2026_AVAILABLE == 'true'
        run: |
          cd build-vs2026
          cmake --build . --config ${{ matrix.build_type }} --parallel

  vs2022-build:
    name: MSVC 2022 Build (${{ matrix.build_type }})
    runs-on: windows-latest
    strategy:
      matrix:
        build_type: >-
          ${{
            github.event_name == 'pull_request' && fromJson('["Release"]') ||
            fromJson('["Release", "Debug"]')
          }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Visual Studio environment
        uses: microsoft/setup-msbuild@v1.1

      - name: Configure CMake
        run: |
          mkdir build-vs2022
          cd build-vs2022
          cmake .. -T v143 # vs2022
      - name: Build
        run: |
          cd build-vs2022
          cmake --build . --config ${{ matrix.build_type }} --parallel

  vs2019-build:
    name: MSVC 2019 Build (${{ matrix.build_type }})
    runs-on: windows-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        build_type: ["Release", "Debug"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Visual Studio environment
        uses: microsoft/setup-msbuild@v1.1

      - name: Configure CMake
        run: |
          mkdir build-vs2019
          cd build-vs2019
          cmake .. -T v142
      - name: Build
        run: |
          cd build-vs2019
          cmake --build . --config ${{ matrix.build_type }} --parallel
  vs2017-build:
    name: MSVC 2017 Build (${{ matrix.build_type }})
    runs-on: windows-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        build_type: ["Release", "Debug"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Visual Studio 2017 Build Tools
        run: |
          # 下载并安装 Visual Studio 2017 Build Tools
          Invoke-WebRequest -Uri "https://aka.ms/vs/15/release/vs_buildtools.exe" -OutFile "vs_buildtools.exe"
          Start-Process -FilePath "vs_buildtools.exe" -ArgumentList "--quiet", "--wait", "--add", "Microsoft.VisualStudio.Workload.VCTools", "--add", "Microsoft.VisualStudio.Component.VC.Tools.x86.x64", "--add", "Microsoft.VisualStudio.Component.Windows10SDK.18362" -NoNewWindow -Wait
        shell: powershell
      
      - name: Setup Visual Studio environment
        uses: microsoft/setup-msbuild@v1.1

      - name: Configure CMake
        run: |
          mkdir build-vs2017
          cd build-vs2017
          cmake .. -T v141 # vs2017

      - name: Build
        run: |
          cd build-vs2017
          cmake --build . --config ${{ matrix.build_type }} --parallel