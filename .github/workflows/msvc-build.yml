name: MSVC Build

on:
  push:
    branches: [ master ]
  pull_request:
    # 所有分支的 PR 都触发
  workflow_dispatch:

jobs:
  vs2026-build:
    name: MSVC 2026 Build (${{ matrix.build_type }})
    runs-on: windows-latest
    strategy:
      matrix:
        build_type: ["Release", "Debug"]
    steps:
      - name: Check VS2026 (v144 toolset) availability
        id: check_vs2026
        run: |
          # Check if VS2026 toolset (v144) is available using vswhere
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          
          # Check for VS2026 installation
          $vs2026 = & $vswhere -version "[18.0,19.0)" -property installationPath 2>$null
          
          # Also check if v144 toolset exists in any VS installation
          $vsInstalls = & $vswhere -all -property installationPath 2>$null
          $v144Found = $false
          foreach ($install in $vsInstalls) {
            $v144Path = Join-Path $install "MSBuild\Microsoft\VC\v144"
            if (Test-Path $v144Path) {
              $v144Found = $true
              echo "✅ v144 toolset found at: $v144Path"
              break
            }
          }
          
          if ($vs2026) {
            echo "VS2026_AVAILABLE=true" >> $env:GITHUB_OUTPUT
            echo "✅ Visual Studio 2026 is installed at: $vs2026"
          } elseif ($v144Found) {
            echo "VS2026_AVAILABLE=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "VS2026_AVAILABLE=false" >> $env:GITHUB_OUTPUT
            echo "⏭️ VS2026 (v144 toolset) is not available on this runner."
            echo "⏭️ Skipping VS2026 build. This is expected until GitHub adds VS2026 support to windows-latest runners."
            echo ""
            echo "=== Available Visual Studio Installations (via vswhere) ==="
            & $vswhere -all -format text
          }
        shell: powershell

      - name: Checkout repository
        if: steps.check_vs2026.outputs.VS2026_AVAILABLE == 'true'
        uses: actions/checkout@v4
      
      - name: Setup Visual Studio environment
        if: steps.check_vs2026.outputs.VS2026_AVAILABLE == 'true'
        uses: microsoft/setup-msbuild@v1.1

      - name: Configure CMake
        if: steps.check_vs2026.outputs.VS2026_AVAILABLE == 'true'
        run: |
          mkdir build-vs2026
          cd build-vs2026
          cmake .. -T v144

      - name: Build
        if: steps.check_vs2026.outputs.VS2026_AVAILABLE == 'true'
        env:
          DO_TEST_RELEASE_LIBS: true
        run: |
          cd build-vs2026
          cmake --build . --config ${{ matrix.build_type }} --parallel

  vs2022-build:
    name: MSVC 2022 Build (${{ matrix.build_type }})
    runs-on: windows-latest
    strategy:
      matrix:
        build_type: ["Release", "Debug"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Visual Studio environment
        uses: microsoft/setup-msbuild@v1.1

      - name: Configure CMake
        run: |
          mkdir build-vs2022
          cd build-vs2022
          cmake .. -T v143 # vs2022
      - name: Build
        env:
          DO_TEST_RELEASE_LIBS: true
        run: |
          cd build-vs2022
          cmake --build . --config ${{ matrix.build_type }} --parallel

  vs2019-build:
    name: MSVC 2019 Build (${{ matrix.build_type }})
    runs-on: windows-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && (contains(github.head_ref, 'workflow') || contains(github.head_ref, 'test')))
    strategy:
      matrix:
        build_type: ["Release", "Debug"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Visual Studio environment
        uses: microsoft/setup-msbuild@v1.1

      - name: Configure CMake
        run: |
          mkdir build-vs2019
          cd build-vs2019
          cmake .. -T v142
      - name: Build
        env:
          DO_TEST_RELEASE_LIBS: true
        run: |
          cd build-vs2019
          cmake --build . --config ${{ matrix.build_type }} --parallel

  # VS2015-2017 使用 windows-2022 runner，预装了 v140/v141 工具集，无需额外安装
  vs2017-build:
    name: MSVC 2017 Build (${{ matrix.build_type }})
    runs-on: windows-2022
    strategy:
      matrix:
        build_type: ["Release", "Debug"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Visual Studio environment
        uses: microsoft/setup-msbuild@v1.1

      - name: Configure CMake
        run: |
          mkdir build-vs2017
          cd build-vs2017
          cmake .. -T v141 # vs2017

      - name: Build
        env:
          DO_TEST_RELEASE_LIBS: true
        run: |
          cd build-vs2017
          cmake --build . --config ${{ matrix.build_type }} --parallel

  vs2015-build:
    name: MSVC 2015 Build (${{ matrix.build_type }})
    runs-on: windows-2022
    strategy:
      matrix:
        build_type: ["Release", "Debug"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Visual Studio environment
        uses: microsoft/setup-msbuild@v1.1

      - name: Configure CMake
        run: |
          mkdir build-vs2015
          cd build-vs2015
          cmake .. -T v140 # vs2015

      - name: Build
        env:
          DO_TEST_RELEASE_LIBS: true
        run: |
          cd build-vs2015
          cmake --build . --config ${{ matrix.build_type }} --parallel

  # VS2010-2013 需要通过 Chocolatey 安装，先检测是否存在
  vs2013-build:
    name: MSVC 2013 Build (${{ matrix.build_type }})
    runs-on: windows-2022
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && (contains(github.head_ref, 'workflow') || contains(github.head_ref, 'test')))
    strategy:
      matrix:
        build_type: ["Release", "Debug"]

    steps:
      - name: Check VS2013 (v120 toolset) availability
        id: check_toolset
        run: |
          $toolsetPath = "C:\Program Files (x86)\Microsoft Visual Studio 12.0\VC"
          if (Test-Path $toolsetPath) {
            echo "TOOLSET_AVAILABLE=true" >> $env:GITHUB_OUTPUT
            echo "✅ VS2013 toolset found"
          } else {
            echo "TOOLSET_AVAILABLE=false" >> $env:GITHUB_OUTPUT
            echo "⏭️ VS2013 toolset not available, will install"
          }
        shell: powershell

      - name: Install Visual Studio 2013 Build Tools
        if: steps.check_toolset.outputs.TOOLSET_AVAILABLE != 'true'
        run: |
          choco install visualstudio2013buildtools -y --no-progress
        shell: powershell

      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Visual Studio environment
        uses: microsoft/setup-msbuild@v1.1

      - name: Configure CMake
        run: |
          mkdir build-vs2013
          cd build-vs2013
          cmake .. -T v120 # vs2013

      - name: Build
        env:
          DO_TEST_RELEASE_LIBS: true
        run: |
          cd build-vs2013
          cmake --build . --config ${{ matrix.build_type }} --parallel

  vs2012-build:
    name: MSVC 2012 Build (${{ matrix.build_type }})
    runs-on: windows-2022
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && (contains(github.head_ref, 'workflow') || contains(github.head_ref, 'test')))
    strategy:
      matrix:
        build_type: ["Release", "Debug"]

    steps:
      - name: Check VS2012 (v110 toolset) availability
        id: check_toolset
        run: |
          $toolsetPath = "C:\Program Files (x86)\Microsoft Visual Studio 11.0\VC"
          if (Test-Path $toolsetPath) {
            echo "TOOLSET_AVAILABLE=true" >> $env:GITHUB_OUTPUT
            echo "✅ VS2012 toolset found"
          } else {
            echo "TOOLSET_AVAILABLE=false" >> $env:GITHUB_OUTPUT
            echo "⏭️ VS2012 toolset not available, will install"
          }
        shell: powershell

      - name: Install Visual Studio 2012 Build Tools
        if: steps.check_toolset.outputs.TOOLSET_AVAILABLE != 'true'
        run: |
          choco install visualstudio2012-buildtools -y --no-progress
        shell: powershell

      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Visual Studio environment
        uses: microsoft/setup-msbuild@v1.1

      - name: Configure CMake
        run: |
          mkdir build-vs2012
          cd build-vs2012
          cmake .. -T v110 # vs2012

      - name: Build
        env:
          DO_TEST_RELEASE_LIBS: true
        run: |
          cd build-vs2012
          cmake --build . --config ${{ matrix.build_type }} --parallel

  vs2010-build:
    name: MSVC 2010 Build (${{ matrix.build_type }})
    runs-on: windows-2022
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && (contains(github.head_ref, 'workflow') || contains(github.head_ref, 'test')))
    strategy:
      matrix:
        build_type: ["Release", "Debug"]

    steps:
      - name: Check VS2010 (v100 toolset) availability
        id: check_toolset
        run: |
          $toolsetPath = "C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC"
          if (Test-Path $toolsetPath) {
            echo "TOOLSET_AVAILABLE=true" >> $env:GITHUB_OUTPUT
            echo "✅ VS2010 toolset found"
          } else {
            echo "TOOLSET_AVAILABLE=false" >> $env:GITHUB_OUTPUT
            echo "⏭️ VS2010 toolset not available, will install"
          }
        shell: powershell

      - name: Install Visual Studio 2010 Build Tools
        if: steps.check_toolset.outputs.TOOLSET_AVAILABLE != 'true'
        run: |
          choco install windows-sdk-7.1 -y --no-progress
          choco install visualstudio2010buildtools -y --no-progress
        shell: powershell

      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Visual Studio environment
        uses: microsoft/setup-msbuild@v1.1

      - name: Configure CMake
        run: |
          mkdir build-vs2010
          cd build-vs2010
          cmake .. -T v100 # vs2010

      - name: Build
        env:
          DO_TEST_RELEASE_LIBS: true
        run: |
          cd build-vs2010
          cmake --build . --config ${{ matrix.build_type }} --parallel